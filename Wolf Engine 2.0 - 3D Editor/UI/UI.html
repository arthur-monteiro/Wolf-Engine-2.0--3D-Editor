<html>
  <head>
	<link rel="stylesheet" href="style.css">
  </head>
  <body>
	<div class="fullscreen" id="fullScreenBlur" style="display: none"></div>
	<button onclick="openModelAdd()">Add model</button>
	<button onclick="selectFileAndLoadScene()">Load</button>
	<button onclick="openSaveSceneWindow()">Save</button>
	<div id="sceneName" style="display: inline-block;">Unknown scene</div>
	<div class="frameRate" id="frameRate">FPS: 60</div>
	<div class="cameraPosition" id="cameraPosition">Camera position:</div>
	<div class="logs" id="logs"></div>

	<div id="addModelWindow" class="modalWindow" style="display: none">
		<table style="width: 100%;">
			<tr>
				<td>Type</td>
				<td>
					<select id="modelTypeSelect" onchange="modelTypeSelectChanged()">
						<option value="staticMesh">Static mesh</option>
						<option value="building">Building</option>
					</select>
				</td>
			</tr>
			<tr id="addModelPathTR">
				<td>Path</td>
				<td id="addModelPath"><button onclick="pickFileAndSetValue('addModelPath', 'open', 'obj')">Select file</button></td>
			</tr>
			<tr id="addModelMaterialPathTR">
				<td>Material path</td>
				<td id="addModelMaterialPath"><button onclick="pickFileAndSetValue('addModelMaterialPath', 'open', 'folder')">Select file</button></td>
			</tr>
			<tr id="addBuildingPathTR" style="display: none;">
				<td>Building path</td>
				<td id="addBuildingPath"><button onclick="pickFileAndSetValue('addBuildingPath', 'save', 'building')">Create</button><button onclick="pickFileAndSetValue('addBuildingPath', 'open', 'building')">Open</button></td>
			</tr>
		</table>
		<button onclick="finishAddModel()">Add model</button>
	</div>

	<div id="saveSceneWindow" class="modalWindow" style="display: none">
		<table style="width: 100%;">
			<tr>
				<td>File</td>
				<td id="saveSceneFile"><button onclick="pickFileAndSetValue('saveSceneFile', 'save', 'save')">Select file</button></td>
			</tr>
			<tr>
				<td>Scene name</td>
				<td id="saveSceneName"><input type="text" id="saveSceneNameInput"/></td>
			</tr>
		</table>
		<button onclick="finishSaveScene()">Save scene</button>
	</div>

	<div id="selectFileWindow" class="modalWindow" style="display: none;">
		<div id="selectFile">Path: <button id="selectFileButton" onclick="pickFileAndSetValue('selectFile', 'open', 'undefined')">Select file</button></div>
		<button id="selectFileFinishButton" onclick="finishFileSelection()">Button placeholder</button>
	</div>

	<div id="infoTabs">
		<button class="tabLink tabSelected" id="tabLinkModel" onclick="selectTabInfo('tabLinkModel', 'modelInfos')" >Model</button>
  		<button class="tabLink" id="tabLinkBuilding"onclick="selectTabInfo('tabLinkBuilding', 'buildingInfos')" style="display: none;">Building</button>
	</div>

	<div id="modelInfos" class="info">
		No model selected
	</div>

	<div id="buildingInfos" class="info" style="display: none; overflow-x: scroll;">
		Building info placeholder
	</div>

	<div id="sliderInfo" onmousedown="resizeInfo()"></div>
	<div id="sliderList" onmousedown="resizeList()"></div>

	<div id="modelList"></div>

    <script src="./slider.js"></script>
    <script src="./select.js"></script>
	<script type="text/javascript">
	function updateFrameRate() {
		document.getElementById('frameRate').innerHTML = getFrameRate();

		setTimeout(()=> {
			updateFrameRate();
		}, 1000);
	}
	
	window.addEventListener('DOMContentLoaded', (event) => {
		setTimeout(()=> {
			updateFrameRate();

			refreshWindowSize();
      	}, 1000);

		if(navigator.userAgent.indexOf('Ultralight') != -1) {
		}
		else {
			document.getElementsByTagName("body")[0].style.backgroundColor = "#191919";

			let script = document.createElement("script"); 
			script.src = "./fakeEngine.js";
			document.head.appendChild(script); 

		}
	});

	function refreshWindowSize() {
		let renderHeight = parseInt(getRenderHeight());
		let infosHeight = renderHeight - 30;

		for(let i = 0; i < document.getElementsByClassName('info').length; ++i) {
			document.getElementsByClassName('info')[i].style.height = String(infosHeight) + "px";
			document.getElementsByClassName('info')[i].style.width = String(parseInt(getRenderOffsetLeft())) + "px";
		}
		document.getElementById('modelList').style.height = getRenderHeight() + "px";
		document.getElementById('modelList').style.left = parseInt(getRenderOffsetLeft()) + parseInt(getRenderWidth());
		document.getElementById('infoTabs').style.width = String(parseInt(getRenderOffsetLeft())) + "px";

		document.getElementById('sliderInfo').style.left = String(parseInt(getRenderOffsetLeft()) - 2) + "px";
		document.getElementById('sliderInfo').style.height = getRenderHeight() + "px";

		document.getElementById('sliderList').style.left = String(parseInt(getRenderOffsetLeft()) + parseInt(getRenderWidth()) - 2) + "px";
		document.getElementById('sliderList').style.height = getRenderHeight() + "px";
	}
	
	function openModelAdd() {
		document.getElementById('fullScreenBlur').style.display = "block";
		document.getElementById('addModelWindow').style.display = "block";
	}

	function finishAddModel() {
		document.getElementById('fullScreenBlur').style.display = "none";
		document.getElementById('addModelWindow').style.display = "none";

		let type = document.getElementById("modelTypeSelect").options[document.getElementById("modelTypeSelect").selectedIndex].value;
		let filepath = "";
		if (type == "staticMesh")
			filepath = document.getElementById("addModelPath").innerHTML;
		else if (type == "building")
			filepath = document.getElementById("addBuildingPath").innerHTML;

		addModel(filepath, document.getElementById("addModelMaterialPath").innerHTML, type);

		document.getElementById("addModelPath").innerHTML = "<button onclick=\"pickFileAndSetValue('addModelPath', 'open', 'obj')\">Select file</button>";
		document.getElementById("addModelMaterialPath").innerHTML = "<button onclick=\"pickFileAndSetValue('addModelMaterialPath', 'open', 'folder')\">Select file</button>";
		document.getElementById("addBuildingPath").innerHTML = "<button onclick=\"pickFileAndSetValue('addBuildingPath', 'save', 'building')\">Create</button><button onclick=\"pickFileAndSetValue('addBuildingPath', 'open', 'building')\">Open</button>";
	}

	function finishSaveScene() {
		document.getElementById('fullScreenBlur').style.display = "none";
		document.getElementById('saveSceneWindow').style.display = "none";
		saveScene(document.getElementById("saveSceneFile").innerHTML, document.getElementById("saveSceneNameInput").value);

		document.getElementById("saveSceneFile").innerHTML = "<button onclick=\"pickFileAndSetValue('saveSceneFile', 'save', 'save')\">Select file</button>";
	}

	let defaultFilter = "undefined";
	function pickFileAndSetValue(id, option, filter) {
		if (filter == "undefined")
			filter = defaultFilter;

		let filepath = pickFile(option, filter);
		document.getElementById(id).innerHTML = filepath;

		if (id == "addModelPath") {
			let materialFolder = filepath.substr(0, filepath.lastIndexOf("\\"));
			document.getElementById("addModelMaterialPath").innerHTML = materialFolder;
		}

		if (id.includes("windowMesh")) {
			changeBuildingWindowMesh(id.replace("windowMesh", ""), filepath, filepath.substr(0, filepath.lastIndexOf("\\")));
		}
	}

	function updateSelectedModelInfo(name, scaleX, scaleY, scaleZ, translateX, translateY, translateZ, rotateX, rotateY, rotateZ) {
		function addVectorInput(name, min, max, vecX, vecY, vecZ) {
			let htmlToAdd = "<div style='padding-bottom: 5px; margin-bottom: 5px; border-bottom: 1px solid white;'>";
			htmlToAdd += "<div style='display: inline-block; float: left; padding: 5px; width: 25%'>" + name + " side size:</div>";
			htmlToAdd += "<div style='display: inline-block; width: 70%'>";
			htmlToAdd += "<wolf-slider max='" + max + "' min='" + min + "' step='0.01' oninput=\"change" + name + "X\" value=\"" + vecX + "\"></wolf-slider>";
			htmlToAdd += "<wolf-slider max='" + max + "' min='" + min + "' step='0.01' oninput=\"change" + name + "Y\" value=\"" + vecY + "\"></wolf-slider>";
			htmlToAdd += "<wolf-slider max='" + max + "' min='" + min + "' step='0.01' oninput=\"change" + name + "Z\" value=\"" + vecZ + "\"></wolf-slider>";
			htmlToAdd += "</div>";
			htmlToAdd += "</div>";

			return htmlToAdd;
		}

		let modelInfosContent = "<div class='blockParameters'>";
		modelInfosContent += "<div class='blockParametersTitle'>General</div>";
		modelInfosContent += "<div class='blockParametersContent'>";
		modelInfosContent += "Name: <input type=\"text\" id=\"nameInput\" name=\"name\" value=\"" + name + "\"/>";
		modelInfosContent += "</div>"; // blockParametersContent
		modelInfosContent += "</div>"; // blockParameters

		modelInfosContent += "<div class='blockParameters'>";
		modelInfosContent += "<div class='blockParametersTitle'>Transform</div>";
		modelInfosContent += "<div class='blockParametersContent'>";
		modelInfosContent += addVectorInput("Scale", -1, 1, scaleX, scaleY, scaleZ);
		modelInfosContent += addVectorInput("Translation", -10, 10, translateX, translateY, translateZ);
		modelInfosContent += addVectorInput("Rotation", 0, 6.29, rotateX, rotateY, rotateZ);
		modelInfosContent += "</div>"; // blockParametersContent
		modelInfosContent += "</div>"; // blockParameters

		document.getElementById('modelInfos').innerHTML = modelInfosContent;
	}

	function updateSelectedBuildingInfo(buildingSizeX, buildingSizeZ, floorCount, windowSideSize, windowsMesh0) {
		document.getElementById("tabLinkBuilding").style.display = "block";

		let buildingInfoContent = "<div class='blockParameters'>";
		buildingInfoContent += "<div class='blockParametersTitle'>General</div>";
		buildingInfoContent += "<div class='blockParametersContent'>";
		buildingInfoContent += "<div style='display: inline-block; float: left; padding: 5px; width: 25%'>Building size:</div>";
		buildingInfoContent += "<div id='buildingSizeSliders' style='display: inline-block; width: 70%'>";
		buildingInfoContent += "<wolf-slider max='150' min='1' step='0.01' oninput='changeBuildingSizeX' value=\"" + buildingSizeX + "\"></wolf-slider>";
		buildingInfoContent += "<wolf-slider max='150' min='1' step='0.01' oninput='changeBuildingSizeZ' value=\"" + buildingSizeZ + "\"></wolf-slider>";
		buildingInfoContent += "</div>"; // buildingSizeSliders
		buildingInfoContent += "</div>"; // blockParametersContent
		buildingInfoContent += "</div>"; // blockParameters

		buildingInfoContent += "<div class='blockParameters'>";
		buildingInfoContent += "<div class='blockParametersTitle'>Floors</div>";
		buildingInfoContent += "<div class='blockParametersContent'>";
		buildingInfoContent += "<div style='display: inline-block; float: left; padding: 5px; width: 25%'>Floor count:</div>";
		buildingInfoContent += "<wolf-slider max='50' min='1' step='1' oninput='changeBuildingFloorCount' value=\"" + floorCount + "\"></wolf-slider>"
		buildingInfoContent += "</div>"; // blockParametersContent
		buildingInfoContent += "</div>";  // blockParameters

		function addBuildingPieceInfos(name, sideSize, mesh0) {
			let nameWithUppercase = name.charAt(0).toUpperCase() + name.slice(1);

			buildingInfoContent += "<div style='width: 100%; height: 50px'>";
			buildingInfoContent += "<div style='display: inline-block; float: left; padding: 5px; width: 25%'>" + nameWithUppercase + " side size:</div>";
			buildingInfoContent += "<wolf-slider max='5' min='0.1' step='0.01' oninput='changeBuilding" + nameWithUppercase + "SideSize' value=\"" + sideSize + "\"></wolf-slider>"
			buildingInfoContent += "</div>";
			buildingInfoContent += "<div style='display: inline-block; float: left; padding: 5px; width: 25%'>" + nameWithUppercase + " meshes:</div>";
			buildingInfoContent += "<table style='width: 70%; border-collapse: collapse; border-radius: 5px'>"
			buildingInfoContent += "<tr><td><div id='" + name + "Mesh0'>" + (mesh0 ? mesh0 : "Default") +"</div></td><td><button onclick=\"pickFileAndSetValue('" + name + "Mesh0', 'open', 'obj')\">Select file</button></td></tr>";
			buildingInfoContent += "<tr><td><div id='" + name + "Mesh1'>No mesh </div></td><td><button onclick=\"pickFileAndSetValue('" + name + "Mesh1', 'open', 'obj')\">Select file</button></td></tr>";
			buildingInfoContent += "<tr><td><div id='" + name + "Mesh2'>No mesh </div></td><td><button onclick=\"pickFileAndSetValue('" + name + "Mesh2', 'open', 'obj')\">Select file</button></td></tr>";
			buildingInfoContent += "</table>"
		}
		
		buildingInfoContent += "<div class='blockParameters'>";
		buildingInfoContent += "<div class='blockParametersTitle'>Windows</div>";
		buildingInfoContent += "<div class='blockParametersContent'>";
		addBuildingPieceInfos("window", windowSideSize, windowsMesh0);
		buildingInfoContent += "</div>"; // blockParametersContent
		buildingInfoContent += "</div>"; // blockParameters

		buildingInfoContent += "<div class='blockParameters'>";
		buildingInfoContent += "<div class='blockParametersTitle'>Walls</div>";
		buildingInfoContent += "<div class='blockParametersContent'>";
		addBuildingPieceInfos("walls", 2, "");
		buildingInfoContent += "</div>"; // blockParametersContent
		buildingInfoContent += "</div>"; // blockParameters

		document.getElementById("buildingInfos").innerHTML = buildingInfoContent;
	}

	function resetSelectedModel() {
		document.getElementById('modelInfos').innerHTML = "No model selected";
		document.getElementById("tabLinkBuilding").style.display = "none";
		document.getElementById("buildingInfos").style.display = "none";
	}

	function addModelToList(name) {
		document.getElementById('modelList').innerHTML += "<div onclick=\"selectModelByName('" + name + "')\">" + name + "</div><br/>";
	}

	function resetModelList() {
		document.getElementById('modelList').innerHTML = "";
	}

	function makeID(length) {
		let result = '';
		const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
		const charactersLength = characters.length;
		let counter = 0;
		while (counter < length) {
			result += characters.charAt(Math.floor(Math.random() * charactersLength));
			counter += 1;
			}
		return result;
	}

	function addLog(log, type) {
		let logID = makeID(10);
		document.getElementById('logs').innerHTML += "<br/><div class='" + type + "' id='" + logID + "'><span style='background-color: #ffffff; opacity: 0.7; padding: 3px 20px 5px 20px;'>" + log + "</span></div>";

		setTimeout(()=> {
			document.getElementById(logID).classList.add("hidden");
		}, 3000);

		setTimeout(()=> {
			document.getElementById(logID).remove();
		}, 4000);
	}

	const FileSelectionActionType = {
		Unknown: 0,
		LoadScene: 1
	};

	let fileSelectionActionType = FileSelectionActionType.Unknown;

	function selectFileAndLoadScene() {
		document.getElementById('fullScreenBlur').style.display = "block";
		document.getElementById('selectFileWindow').style.display = "block";
		document.getElementById('selectFileFinishButton').innerHTML = "Load";
		defaultFilter = "save";

		fileSelectionActionType = FileSelectionActionType.LoadScene;
	}

	function finishFileSelection() {
		let path = document.getElementById("selectFile").innerHTML;

		switch (fileSelectionActionType){
			case FileSelectionActionType.Unknown:
				// Error
				break;
			case FileSelectionActionType.LoadScene:
				loadScene(path);
				break;
		}

		document.getElementById('fullScreenBlur').style.display = "none";
		document.getElementById('selectFileWindow').style.display = "none";
		document.getElementById('selectFile').innerHTML = "Path: <button id=\"selectFileButton\" onclick=\"pickFileAndSetValue('selectFile', 'open', 'undefined')\">Select file</button>";
	}

	function openSaveSceneWindow() {
		document.getElementById('fullScreenBlur').style.display = "block";
		document.getElementById('saveSceneWindow').style.display = "block";
	}

	function setSceneName(name) {
		document.getElementById('sceneName').innerHTML = name;
	}

	function modelTypeSelectChanged() {
		let selectedOption = document.getElementById("modelTypeSelect").options[document.getElementById("modelTypeSelect").selectedIndex].value;

		if (selectedOption == "staticMesh") {
			document.getElementById("addModelPathTR").style.display = "table-row";
			document.getElementById("addModelMaterialPathTR").style.display = "table-row";
			document.getElementById("addBuildingPathTR").style.display = "none";
		}
		else {
			document.getElementById("addModelPathTR").style.display = "none";
			document.getElementById("addModelMaterialPathTR").style.display = "none";
			document.getElementById("addBuildingPathTR").style.display = "table-row";
		}
	}

	function selectTabInfo(tabID, infoID) {
		let tabLinks = document.getElementsByClassName("tabLink");
		for (var i = 0; i < tabLinks.length; ++i) {
			var tabLink = tabLinks[i];  
			tabLink.classList.remove("tabSelected");
		}
		document.getElementById(tabID).classList.add("tabSelected");

		let infoDivs = document.getElementsByClassName("info");
		for (var i = 0; i < infoDivs.length; ++i) {
			var infoDiv = infoDivs[i];  
			infoDiv.style.display = "none";
		}
		document.getElementById(infoID).style.display = "block";
	}

	function setCameraPosition(cameraPositionStr) {
		document.getElementById("cameraPosition").innerHTML = "Camera position: " + cameraPositionStr;
	}

	function resizeInfo() {
		let dragX = undefined; 
		document.onmousemove = function onMouseMove(e) {
			let maxOffsetWidth = 0;
			for(let i = 0; i < document.getElementsByClassName('info').length; ++i) {
				if (document.getElementsByClassName('info')[i].style.display != "none")
					maxOffsetWidth = document.getElementsByClassName('info')[i].offsetWidth;
			}

			if (dragX == undefined)
				dragX = e.clientX;
			let newWidth = maxOffsetWidth + e.clientX - dragX;

			if (newWidth < 150)
				newWidth = 150;
			if (newWidth > 1000)
				newWidth = 1000;

			for(let i = 0; i < document.getElementsByClassName('info').length; ++i) {
				document.getElementsByClassName('info')[i].style.width = newWidth + "px";
			}
			
			document.getElementById("infoTabs").style.width = newWidth + "px";
			document.getElementById("sliderInfo").style.left = newWidth + "px";

			setRenderOffsetLeft(newWidth);

			dragX = e.clientX;
		}
		document.onmouseup = () => document.onmousemove = document.onmouseup = null;
	}

	function resizeList(e) {
		let dragX = undefined;
		let modelListLeft = parseInt(document.getElementById("modelList").style.left);
		let modelListWidth = parseInt(document.getElementById("modelList").offsetWidth);
		document.onmousemove = function onMouseMove(e) {
			let offsetWidth = document.getElementById('modelList').offsetWidth;

			if (dragX == undefined)
				dragX = e.clientX;
			let newWidth = offsetWidth + dragX - e.clientX;

			if (newWidth < 150)
				newWidth = 150;
			if (newWidth > 1000)
				newWidth = 1000;

			document.getElementById("modelList").style.width = newWidth + "px";

			let newLeft = modelListLeft - (newWidth - modelListWidth);
			document.getElementById("modelList").style.left = newLeft + "px";
			document.getElementById("sliderList").style.left = newLeft + "px";

			setRenderOffsetRight(newWidth + 5);

			dragX = e.clientX;
		}
		document.onmouseup = () => document.onmousemove = document.onmouseup = null;
	}
    </script>
  </body>
</html>