<html>
  <head>
	<link rel="stylesheet" href="style.css">	
	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
  </head>
  <body>
	<div id="staticElements">
		<div id="actionButtons">
			<button class="actionButton" onclick="openModelAdd()">Add model</button>
			<button class="actionButton" onclick="selectFileAndLoadScene()">Load</button>
			<button class="actionButton" onclick="openSaveSceneWindow()">Save</button>
			<div id="sceneName" style="display: inline-block;">Unknown scene</div>
			<div id="optionsIcon" style="float: right; padding: 5px 10px 0px 0px; cursor: pointer;" onclick="openOptions()"><div class="material-symbols-outlined">settings</div></div>
		</div>
		<div class="frameRate" id="frameRate">FPS: 60</div>
		<div class="cameraPosition" id="cameraPosition">Camera position:</div>
		<div class="logs" id="logs"></div>

		<div id="infoTabs">
			<button class="tabLink tabSelected" id="tabLinkModel" onclick="selectTabInfo('tabLinkModel', 'modelInfos')" >Model</button>
			  <button class="tabLink" id="tabLinkBuilding"onclick="selectTabInfo('tabLinkBuilding', 'buildingInfos')" style="display: none;">Building</button>
		</div>
	
		<div id="modelInfos" class="info">
			<span>No model selected</span>
		</div>

		<div id="buildingInfos" class="info" style="display: none; overflow-x: scroll;">
			Building info placeholder
		</div>

		<div id="sliderInfo" onmousedown="resizeInfo()"></div>
		<div id="sliderList" onmousedown="resizeList()"></div>

		<div id="modelList"></div>
	</div>

	<div id="addModelWindow" class="modalWindow" style="display: none">
		<div id="closeButton" onclick="closeModelAdd()" style="cursor: pointer"><div style="display: block; transform: translate(-1px, -5px); font: message-box;">X</div></div>
		<ul style="padding: 0px 10px 0px 10px; margin-bottom: -5px;">
			<li class="table-row">
				<div class="col col-1" data-label="infoType">Type</div>
				<div class="columnDivider"></div>
				<div class="col col-2" data-label="infoValue" style="display: block;">
					<select id="modelTypeSelect" onchange="modelTypeSelectChanged()">
						<option value="staticMesh">Static mesh</option>
						<option value="building">Building</option>
					</select>
				</div>
			</li>
			<li class="table-row" id="addModelPathTR">
				<div class="col col-1" data-label="infoType">Path</div>
				<div class="columnDivider"></div>
				<div class="col col-2" data-label="infoValue">
					<button style="width: 30%;" class="actionButton" onclick="pickFileAndSetValue('addModelPath', 'open', 'obj')">Select file</button>
					<div id="addModelPath" style="width: 70%; white-space: nowrap; overflow: auto; transform: translate(10px, 0px); height: 35px; font-size: 12px;">No file selected</div>
				</div>
			</li>
			<li class="table-row" id="addModelMaterialPathTR">
				<div class="col col-1" data-label="infoType">Material path</div>
				<div class="columnDivider"></div>
				<div class="col col-2" data-label="infoValue">
					<button style="width: 30%;" class="actionButton" onclick="pickFileAndSetValue('addModelMaterialPath', 'open', 'folder')">Select folder</button>
					<div id="addModelMaterialPath" style="width: 70%; white-space: nowrap; overflow: auto; transform: translate(10px, 0px); height: 35px; font-size: 12px;">No folder selected</div>
				</div>
			</li>
			<li class="table-row" id="addBuildingPathTR" style="display: none;">
				<div class="col col-1" data-label="infoType">Building path</div>
				<div class="columnDivider"></div>
				<div class="col col-2" data-label="infoValue" id="addBuildingPath" style="display: block;">
					<button class="actionButton" onclick="pickFileAndSetValue('addBuildingPath', 'save', 'building')">Create</button>
					<button class="actionButton" onclick="pickFileAndSetValue('addBuildingPath', 'open', 'building')">Open</button>
				</div>
			</li>
		</ul>
		<button class="validationButton" onclick="finishAddModel()">Add model</button>
	</div>

	<div id="saveSceneWindow" class="modalWindow" style="display: none">
		<table style="width: 100%;">
			<tr>
				<td>File</td>
				<td id="saveSceneFile"><button onclick="pickFileAndSetValue('saveSceneFile', 'save', 'save')">Select file</button></td>
			</tr>
			<tr>
				<td>Scene name</td>
				<td id="saveSceneName"><input type="text" id="saveSceneNameInput"/></td>
			</tr>
		</table>
		<button onclick="finishSaveScene()">Save scene</button>
	</div>

	<div id="selectFileWindow" class="modalWindow" style="display: none;">
		<div id="selectFile">Path: <button id="selectFileButton" onclick="pickFileAndSetValue('selectFile', 'open', 'undefined')">Select file</button></div>
		<button id="selectFileFinishButton" onclick="finishFileSelection()">Button placeholder</button>
	</div>

	<div id="options" class="modalWindow" style="display: none;">
		<div id="closeButton" onclick="closeOptions()" style="cursor: pointer"><div style="display: block; transform: translate(-1px, -5px); font: message-box;">X</div></div>
		<ul style="padding: 0px 10px 0px 10px; margin-bottom: -5px;">
			<li class="table-row">
				<div class="col col-1" data-label="infoType">Display</div>
				<div class="columnDivider"></div>
				<div class="col col-2" data-label="infoValue" style="display: block; margin-right: 8px">
					<select id="displayTypeSelect" onchange="displayTypeSelectChanged(this.options[this.selectedIndex].value)">
						<option value="albedo">Albedo</option>
						<option value="normal">Normal</option>
						<option value="roughness">Rougness</option>
						<option value="metalness">Metalness</option>
						<option value="matAO">Material AO</option>
					</select>
				</div>
			</li>
			<li class="table-row">
				<div class="col col-1" data-label="infoType">Camera</div>
				<div class="columnDivider"></div>
				<div class="col col-2" data-label="infoValue" style="display: block; margin-right: 8px">
					<select id="cameraTypeSelect" onchange="cameraTypeSelectChanged(this.options[this.selectedIndex].value)">
						<option value="fps">FPS</option>
					</select>
				</div>
			</li>
		</ul>
	</div>

    <script src="./slider.js"></script>
    <script src="./select.js"></script>
	<script src="./paramsEdition.js"></script>
	<script type="text/javascript">
	function updateFrameRate() {
		document.getElementById('frameRate').innerHTML = getFrameRate();

		setTimeout(()=> {
			updateFrameRate();
		}, 1000);
	}
	
	window.addEventListener('DOMContentLoaded', (event) => {
		setTimeout(()=> {
			updateFrameRate();

			refreshWindowSize();
      	}, 1000);

		if(navigator.userAgent.indexOf('Ultralight') != -1) {
		}
		else {
			document.getElementsByTagName("body")[0].style.backgroundColor = "#191919";

			let script = document.createElement("script"); 
			script.src = "./fakeEngine.js";
			document.head.appendChild(script);
		}

		// Remove focus of inputs when pressing "enter"
		addEventListener("keypress", (event) => {
			if (event.which == 13) {
				let inputs = document.getElementsByTagName("input");
				for (const input of inputs) {
					input.blur();
				}
			}
		});
	});

	function refreshWindowSize() {
		let renderHeight = parseInt(getRenderHeight());
		let infosHeight = renderHeight - 30;

		for(let i = 0; i < document.getElementsByClassName('info').length; ++i) {
			document.getElementsByClassName('info')[i].style.height = String(infosHeight) + "px";
			document.getElementsByClassName('info')[i].style.width = String(parseInt(getRenderOffsetLeft())) + "px";
		}
		document.getElementById('modelList').style.height = getRenderHeight() + "px";
		document.getElementById('modelList').style.left = parseInt(getRenderOffsetLeft()) + parseInt(getRenderWidth());
		document.getElementById('infoTabs').style.width = String(parseInt(getRenderOffsetLeft())) + "px";

		document.getElementById('sliderInfo').style.left = String(parseInt(getRenderOffsetLeft()) - 2) + "px";
		document.getElementById('sliderInfo').style.height = getRenderHeight() + "px";

		document.getElementById('sliderList').style.left = String(parseInt(getRenderOffsetLeft()) + parseInt(getRenderWidth()) - 2) + "px";
		document.getElementById('sliderList').style.height = getRenderHeight() + "px";
	}

	function openModalWindow() {
	}

	function closeModalWindow() {
	}
	
	function openModelAdd() {
		document.getElementById('addModelWindow').style.display = "block";
		openModalWindow();
	}

	function closeModelAdd() {
		document.getElementById('addModelWindow').style.display = "none";
		closeModalWindow();
	}

	function finishAddModel() {
		document.getElementById('addModelWindow').style.display = "none";

		let type = document.getElementById("modelTypeSelect").options[document.getElementById("modelTypeSelect").selectedIndex].value;
		let filepath = "";
		if (type == "staticMesh")
			filepath = document.getElementById("addModelPath").innerHTML;
		else if (type == "building")
			filepath = document.getElementById("addBuildingPath").innerHTML;

		addModel(filepath, document.getElementById("addModelMaterialPath").innerHTML, type);

		document.getElementById("addModelPath").innerHTML = "No file selected";
		document.getElementById("addModelMaterialPath").innerHTML = "No folder selected";
		document.getElementById("addBuildingPath").innerHTML = "<button onclick=\"pickFileAndSetValue('addBuildingPath', 'save', 'building')\">Create</button><button onclick=\"pickFileAndSetValue('addBuildingPath', 'open', 'building')\">Open</button>";
	}

	function finishSaveScene() {
		document.getElementById('saveSceneWindow').style.display = "none";
		saveScene(document.getElementById("saveSceneFile").innerHTML, document.getElementById("saveSceneNameInput").value);

		document.getElementById("saveSceneFile").innerHTML = "<button onclick=\"pickFileAndSetValue('saveSceneFile', 'save', 'save')\">Select file</button>";
	}

	function openOptions() {
		document.getElementById("options").style.display = "block";
		openModalWindow();
	}
	
	function closeOptions() {
		document.getElementById("options").style.display = "none";
		closeModalWindow();
	}

	let defaultFilter = "undefined";
	function pickFileAndSetValue(id, option, filter, callback) {
		if (filter == "undefined")
			filter = defaultFilter;

		let filepath = pickFile(option, filter);
		document.getElementById(id).innerHTML = filepath;

		if (callback != undefined)
			callback(filepath);

		if (id == "addModelPath") {
			let materialFolder = filepath.substr(0, filepath.lastIndexOf("\\"));
			document.getElementById("addModelMaterialPath").innerHTML = materialFolder;
		}
	}

	function resetSelectedModel() {
		document.getElementById('modelInfos').innerHTML = "No model selected";
		document.getElementById("tabLinkBuilding").style.display = "none";
		document.getElementById("buildingInfos").style.display = "none";
	}

	function addModelToList(name) {
		document.getElementById('modelList').innerHTML += "<div class='modelListItem' onclick=\"selectModelByName('" + name + "')\">" + name + "</div><br/>";
	}

	function resetModelList() {
		document.getElementById('modelList').innerHTML = "";
	}

	function makeID(length) {
		let result = '';
		const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
		const charactersLength = characters.length;
		let counter = 0;
		while (counter < length) {
			result += characters.charAt(Math.floor(Math.random() * charactersLength));
			counter += 1;
			}
		return result;
	}

	function addLog(log, type) {
		let logID = makeID(10);
		document.getElementById('logs').innerHTML += "<br/><div class='" + type + "' id='" + logID + "'><span style='background-color: #ffffff; opacity: 0.7; padding: 3px 20px 5px 20px;'>" + log + "</span></div>";

		setTimeout(()=> {
			document.getElementById(logID).classList.add("hidden");
		}, 3000);

		setTimeout(()=> {
			document.getElementById(logID).remove();
		}, 4000);
	}

	const FileSelectionActionType = {
		Unknown: 0,
		LoadScene: 1
	};

	let fileSelectionActionType = FileSelectionActionType.Unknown;

	function selectFileAndLoadScene() {
		document.getElementById('selectFileWindow').style.display = "block";
		document.getElementById('selectFileFinishButton').innerHTML = "Load";
		defaultFilter = "save";

		fileSelectionActionType = FileSelectionActionType.LoadScene;
	}

	function finishFileSelection() {
		let path = document.getElementById("selectFile").innerHTML;

		switch (fileSelectionActionType){
			case FileSelectionActionType.Unknown:
				// Error
				break;
			case FileSelectionActionType.LoadScene:
				loadScene(path);
				break;
		}

		document.getElementById('selectFileWindow').style.display = "none";
		document.getElementById('selectFile').innerHTML = "Path: <button id=\"selectFileButton\" onclick=\"pickFileAndSetValue('selectFile', 'open', 'undefined')\">Select file</button>";
	}

	function openSaveSceneWindow() {
		document.getElementById('saveSceneWindow').style.display = "block";
	}

	function setSceneName(name) {
		document.getElementById('sceneName').innerHTML = name;
	}

	function modelTypeSelectChanged() {
		let selectedOption = document.getElementById("modelTypeSelect").options[document.getElementById("modelTypeSelect").selectedIndex].value;

		if (selectedOption == "staticMesh") {
			document.getElementById("addModelPathTR").style.display = "inline-flex";
			document.getElementById("addModelMaterialPathTR").style.display = "inline-flex";
			document.getElementById("addBuildingPathTR").style.display = "none";
		}
		else {
			document.getElementById("addModelPathTR").style.display = "none";
			document.getElementById("addModelMaterialPathTR").style.display = "none";
			document.getElementById("addBuildingPathTR").style.display = "inline-flex";
		}
	}

	function selectTabInfo(tabID, infoID) {
		let tabLinks = document.getElementsByClassName("tabLink");
		for (var i = 0; i < tabLinks.length; ++i) {
			var tabLink = tabLinks[i];  
			tabLink.classList.remove("tabSelected");
		}
		document.getElementById(tabID).classList.add("tabSelected");

		let infoDivs = document.getElementsByClassName("info");
		for (var i = 0; i < infoDivs.length; ++i) {
			var infoDiv = infoDivs[i];  
			infoDiv.style.display = "none";
		}
		document.getElementById(infoID).style.display = "block";
	}

	function setCameraPosition(cameraPositionStr) {
		document.getElementById("cameraPosition").innerHTML = "Camera position: " + cameraPositionStr;
	}

	function resizeInfo() {
		let dragX = undefined; 
		document.onmousemove = function onMouseMove(e) {
			let maxOffsetWidth = 0;
			for(let i = 0; i < document.getElementsByClassName('info').length; ++i) {
				if (document.getElementsByClassName('info')[i].style.display != "none")
					maxOffsetWidth = document.getElementsByClassName('info')[i].offsetWidth;
			}

			if (dragX == undefined)
				dragX = e.clientX;
			let newWidth = maxOffsetWidth + e.clientX - dragX;

			if (newWidth < 150)
				newWidth = 150;
			if (newWidth > 1000)
				newWidth = 1000;

			for(let i = 0; i < document.getElementsByClassName('info').length; ++i) {
				document.getElementsByClassName('info')[i].style.width = newWidth + "px";
			}
			
			document.getElementById("infoTabs").style.width = newWidth + "px";
			document.getElementById("sliderInfo").style.left = newWidth + "px";

			setRenderOffsetLeft(newWidth);

			dragX = e.clientX;
		}
		document.onmouseup = () => document.onmousemove = document.onmouseup = null;
	}

	function resizeList(e) {
		let dragX = undefined;
		let modelListLeft = parseInt(document.getElementById("modelList").style.left);
		let modelListWidth = parseInt(document.getElementById("modelList").offsetWidth);
		document.onmousemove = function onMouseMove(e) {
			let offsetWidth = document.getElementById('modelList').offsetWidth;

			if (dragX == undefined)
				dragX = e.clientX;
			let newWidth = offsetWidth + dragX - e.clientX;

			if (newWidth < 150)
				newWidth = 150;
			if (newWidth > 1000)
				newWidth = 1000;

			document.getElementById("modelList").style.width = newWidth + "px";

			let newLeft = modelListLeft - (newWidth - modelListWidth);
			document.getElementById("modelList").style.left = newLeft + "px";
			document.getElementById("sliderList").style.left = newLeft + "px";

			setRenderOffsetRight(newWidth + 5);

			dragX = e.clientX;
		}
		document.onmouseup = () => document.onmousemove = document.onmouseup = null;
	}
    </script>
  </body>
</html>